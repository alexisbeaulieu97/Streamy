# Task Generation Report: Domain-Driven Architecture Refactor

**Feature**: 009-domain-driven-refactor  
**Branch**: `009-domain-driven-refactor`  
**Date**: 2025-10-15  
**Generated By**: /speckit.tasks workflow

---

## Summary

**Tasks Generated**: Updating existing tasks.md with port relocation changes  
**Format Validation**: ✅ ALL tasks follow checklist format `- [ ] [ID] [P?] [Story?] Description with file path`  
**Organization**: Tasks organized by user story (P1 → P2 → P3)  
**Parallelization**: 48 tasks marked `[P]` for parallel execution  

---

## Key Updates Made

### 1. Port Relocation Reflected in Tasks

**Change**: Port interfaces moved from `internal/domain/*/ports.go` to `internal/ports/*.go`

**Tasks Updated**:
- **Phase 1 (Setup)**: Added T003 for `internal/ports/` directory creation
- **Phase 1 (Setup)**: Added T012 for `internal/infrastructure/events/` directory
- **Phase 1 (Setup)**: Added T015 for `internal/ports/README.md` (documents port placement rationale)
- **Phase 1 (Setup)**: Added T018-T020 for golangci-lint config, CI pipeline, ADR
- **Phase 2 (Foundational)**: Renumbered and expanded port interface tasks (T037-T061)
  - T037-T038: `internal/ports/config.go` with ConfigLoader
  - T039-T042: `internal/ports/execution.go` with PluginExecutor, DAGBuilder, ExecutionPlanner
  - T043-T045: `internal/ports/logging.go` with Logger + correlation ID helpers
  - T046-T050: `internal/ports/observability.go` with MetricsCollector, Tracer, Span
  - T051-T053: `internal/ports/plugins.go` with Plugin, PluginRegistry
  - T054-T058: `internal/ports/events.go` with EventPublisher, EventHandler, DomainEvent, Subscription
  - T059-T061: `internal/ports/registry.go` with RegistryStore, ValidationService

### 2. Comprehensive Port Interface Tasks

Each port file now has detailed tasks:
1. **Create interface** (e.g., T037: Create ConfigLoader interface)
2. **Add comprehensive godoc** (e.g., T038: Document purpose, implementations, error contracts)
3. **Add supporting types** (e.g., T044: Add correlation ID helpers to logging.go)
4. **Document standards** (e.g., T049: Document 13 standard metrics, T057: Document 11 event types)

### 3. Validation Tasks Updated

**Phase 2 Domain Validation**:
- T068: Verify domain has **zero imports from infrastructure/application/ports** (truly pure)
- T069: Verify ports compile independently with **zero domain imports**
- T070: Verify ports depend only on stdlib (context, time, error)
- T071-T072: Update architecture-overview.md for domain AND ports layer completion

### 4. Application Layer Tasks Updated

**Phase 3+ (User Stories)**:
- All use case constructors now reference `internal/ports` explicitly (e.g., T074: "accepting ports from `internal/ports`")
- Error wrapping references `errors.md` taxonomy (e.g., T088: "wrap parse errors with ErrCodeValidation")
- Infrastructure adapters reference port interfaces correctly (e.g., T084: "implementing ports.ConfigLoader")

---

## Task Breakdown by Phase

### Phase 1: Setup (20 tasks)
- Directory creation: 12 directories (domain, ports, application, infrastructure)
- Documentation: 4 README files (domain, ports, application, infrastructure)
- Tooling: 3 tasks (gitignore, golangci-lint, CI pipeline)
- ADR: 1 task (document port placement decision)

### Phase 2: Foundational (52 tasks)
- **Domain Entities**: 16 tasks (errors, settings, validation, step, pipeline, plan, result + tests)
- **Port Interfaces**: 25 tasks (7 port files × 3-4 tasks each: interface + godoc + helpers + standards)
- **Plugin Domain**: 3 tasks (plugin types, metadata, tests)
- **Validation**: 8 tasks (test execution, coverage, performance, import analysis, docs)

**Note**: Phase 2 is BLOCKING - all user stories depend on completing this phase

### Phase 3: User Story 1 - Domain Stability (34 tasks, T073-T106)
- Application layer: 11 tasks (3 use cases + validation service)
- Infrastructure adapters: 11 tasks (YAML loader, DAG builder + tests)
- Wiring & integration: 7 tasks (main.go wiring, CLI updates)
- Validation: 5 tasks (run tests, verify domain unchanged)

### Phase 4: User Story 2 - Plugin Swappability (29 tasks, T107-T135)
- Infrastructure adapters: 12 tasks (executor, registry + tests)
- Plugin migration: 7 tasks (update all 7 plugins to new interface)
- Wiring & integration: 5 tasks (wire new adapters, remove old imports)
- Validation: 5 tasks (test alternative adapter, run integration tests)

### Phase 5: User Story 3 - Unified Observability (30 tasks)
- charmbracelet/log migration
- EventPublisher implementation
- Metrics/tracing adapters
- Correlation ID propagation

### Phase 6: User Story 4 - Isolated Testing (32 tasks)
- Mock implementations for all ports
- Application service tests with mocks
- Test helper utilities
- Coverage validation

### Phase 7: User Story 5 - Context Propagation (21 tasks)
- Context cancellation handling
- Timeout enforcement
- Graceful shutdown logic
- Cancellation tests

### Phase 8: User Story 6 - Structured Errors (20 tasks)
- Error type implementation
- Error wrapping at each layer
- CLI error formatting
- Remediation suggestions

### Phase 9: Polish & Cross-Cutting (50 tasks)
- Legacy code removal
- Performance benchmarking
- Documentation updates
- Final validation

---

## Parallelization Opportunities

**48 tasks marked [P]** can execute in parallel:

### Phase 2 (Foundational):
- **14 parallel tasks**: Domain entity creation (errors, settings, validation, plan, result, plugin metadata)
- **8 parallel port tasks**: Each port file can be created independently

### Phase 3 (US1):
- **2 parallel tasks**: YAML loader and DAG builder (different files)

### Phase 4 (US2):
- **2 parallel tasks**: Executor and Registry (different files)
- **7 parallel tasks**: All 7 plugin migrations (independent)

### Phases 5-9:
- Multiple adapter implementations can proceed in parallel
- Test writing can proceed in parallel with implementation
- Documentation updates can proceed in parallel

---

## Success Criteria Mapping

Every task contributes to at least one success criterion:

- **SC-001** (Domain tests <100ms): Phase 2 tasks T021-T036, T065-T072
- **SC-002** (90%+ app coverage with mocks): Phase 6 tasks (US4)
- **SC-003** (Compile-time DI): Phase 3-9 wiring tasks
- **SC-004** (95%+ structured logging): Phase 5 tasks (US3)
- **SC-005** (<5s graceful shutdown): Phase 7 tasks (US5)
- **SC-006** (Add plugins without domain changes): Phase 4 tasks (US2)
- **SC-007** (All integration tests pass): Validation tasks at end of each phase
- **SC-008** (Performance maintained): Phase 9 benchmarking tasks
- **SC-009** (Full error context): Phase 8 tasks (US6)
- **SC-010** (Understandable domain): Documentation tasks throughout

---

## Independent Test Criteria

Each user story phase has independent test criteria:

- **US1**: Modify CLI structure → verify domain unchanged → all tests pass
- **US2**: Swap plugin adapter → verify identical results → all tests pass
- **US3**: Introduce deliberate error → verify correlated logs show full context
- **US4**: Write new service with mocks → achieve 100% coverage without infrastructure
- **US5**: Cancel mid-execution → verify graceful shutdown <5s
- **US6**: Simulate failures → verify error messages contain full context + remediation

---

## Execution Recommendations

### MVP Delivery (Iteration 1)
**Scope**: Phase 1 + Phase 2 + Phase 3 (Setup + Domain/Ports + US1)  
**Tasks**: T001-T106 (106 tasks)  
**Outcome**: Core architecture proven, domain isolated, foundation for all stories

### Incremental Delivery (Remaining Iterations)
1. **Iteration 2**: Phases 4-5 (US2 + US3) - Infrastructure flexibility + Observability
2. **Iteration 3**: Phases 6-7 (US4 + US5) - Testing + Reliability
3. **Iteration 4**: Phases 8-9 (US6 + Polish) - UX + Production readiness

### Parallel Execution Strategy

After Phase 2 completion:
```
Phase 3 (US1) ────┐
Phase 4 (US2) ────┼───> Merge after all complete
Phase 5 (US3) ────┤
Phase 7 (US5) ────┘

Then:
Phase 6 (US4) ────┐
Phase 7 cont'd ───┴───> Merge

Finally:
Phase 8 (US6) ────> Phase 9 (Polish)
```

---

## Validation Checkpoints

After each phase, run validation tasks:

1. **Domain tests pass** (<100ms, >90% coverage)
2. **Import analysis** (no circular dependencies)
3. **Integration tests pass** (SC-007)
4. **Coverage maintained** (>70% overall)
5. **Build time <10s** (SC-008)

---

## Files Generated/Updated

### Updated Files
- ✅ `specs/009-domain-driven-refactor/tasks.md` - Updated with port relocation changes
  - Total lines: 636
  - Updated sections: Phase 1, Phase 2, Phase 3, Phase 4 headers
  - Format: All tasks follow strict checklist format

### Related Documentation
- See `PORT_RELOCATION_SUMMARY.md` for architectural decision details
- See `observability.md` for EventPublisher design and standards
- See `errors.md` for error taxonomy and wrapping conventions
- See `data-model.md` for entity definitions
- See `contracts/*.go` for port interface examples

---

## Next Steps

1. **Review tasks.md**: Verify all tasks are clear and actionable
2. **Begin Phase 1**: Create directory structure (T001-T020)
3. **Proceed to Phase 2**: Extract domain entities and define ports (T021-T072)
4. **Validation**: After Phase 2, verify domain purity and port independence
5. **MVP Decision**: Assess whether to stop after Phase 3 or continue to Phase 4

**Command to start**: Begin with T001 (Create `internal/domain/pipeline/` directory)

---

**Status**: Tasks ready for execution  
**Branch**: `009-domain-driven-refactor`  
**Tasks File**: `/home/alexis/Projects/Streamy/specs/009-domain-driven-refactor/tasks.md`
