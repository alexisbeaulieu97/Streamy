#!/bin/sh
#
# Pre-commit hook that runs gofmt on staged Go files.
# If any files need formatting, the commit is aborted.
#
# To install this hook:
#   cp pre-commit .git/hooks/
#   chmod +x .git/hooks/pre-commit

# Get a list of staged Go files
gofiles=$(git diff --cached --name-only --diff-filter=ACM | grep '\.go$')

if [ -z "$gofiles" ]; then
    exit 0
fi

# Run gofmt on the staged files
unformatted=$(gofmt -l $gofiles)

if [ -n "$unformatted" ]; then
    echo "Go files must be formatted with gofmt. Please run:"
    echo ""
    echo "  gofmt -w $unformatted"
    echo ""
    echo "and then stage the changes again."
    echo ""
    echo "Unformatted files:"
    for file in $unformatted; do
        echo "  - $file"
    done
    exit 1
fi

# Optionally, also run gofmt with -s to simplify code
simplified=$(gofmt -s -l $gofiles)

if [ -n "$simplified" ]; then
    echo "Go files can be simplified with gofmt -s. Please run:"
    echo ""
    echo "  gofmt -s -w $simplified"
    echo ""
    echo "and then stage the changes again."
    echo ""
    echo "Files that can be simplified:"
    for file in $simplified; do
        echo "  - $file"
    done
    exit 1
fi

exit 0